.\" Generated by Mmark Markdown Processer - mmark.miek.nl
.TH "PGOD" 8 "May 2023" "System Administration" "Podman Compose"

.SH "PGOD"
.SH "NAME"
.PP
pgod - watch a git repository, pull changes and restart the podman compose service

.SH "SYNOPSIS"
.PP
\fB\fCpgod [OPTION]...\fR \fB\fC-c\fR \fBCONFIG\fP

.SH "DESCRIPTION"
.PP
\fB\fCpgod\fR clones and pulls all repositories that are defined in the config file. It then exposes a SSH
interface (on port 2222) which you can interact with using pgoctl(1) or plain ssh(1) (not tested).

.PP
Each compose file runs under it's own user-account. That account can then access storage, or
databases it has access too - provisioning that stuff is out-of-scope - assuming your infra can deal
with all that stuff. And make that available on each server.

.PP
Servers running pgod(8) as still special in some regard, a developers needs to know which server runs
their compose file \fIand\fP you need to administrate who own which port numbers. Moving services to a
different machine is as easy as starting the compose there, but you need to make sure your infra
also updates externals records (DNS for example).

.PP
The interface into \fB\fCpgod\fR is via SSH, but not the normal SSH running on the server, this is a
completely seperate SSH interface implemented by both \fB\fCpgod\fR and \fB\fCpgoctl\fR.

.PP
The main idea here is that developers can push stuff easier to production and that you can have some
of the goodies from Kubernetes, but not that bad stuff like the networking - the big trade-off being
you need to administrate port numbers \fIand\fP still run some proxy to forward URLs to the correct
backend.

.PP
For each repository it directs podman-compose to pull, build and start the containers defined in the
\fB\fCdocker-compose.yml\fR file. Whenever this compose file changes this is redone.

.PP
With pgoctl(1) you can then interact with these services. You can "up", "down", "ps", "pull",
"logs", and "ping" currently. The syntax exposed is \fB\fC<servicename>//<command>\fR, i.e. \fB\fCpgo//ps\fR.

.PP
The options are:

.TP
\fB-c, --config string\fP
config file to read
.TP
\fB-s, --ssh string\fP
ssh address to listen on (default ":2222")
.TP
\fB-d, --debug\fP
enable debug logging
.TP
\fB-r, --restart\fP
send SIGHUP to ourselves when config changes
.TP
\fB-o, --root\fP
require root permission, setting to false can aid in debugging (default true)
.TP
\fB-t, --duration duration\fP
default duration between pulls (default 5m0s)


.SH "CONFIG FILE"
.PP
\fB\fCpgod\fR requires a TOML config file where the services are defined, an example config file looks like
this:

.PP
.RS

.nf
[[services]]
name = "pgo"
user = "miek"  # under which user to run the podman
group = "miek" # which group to run the podman // not used atm
repository = "https://github.com/miekg/pgo"
branch = "main"
urls = { "example.org" = ":5006" }
ports = [ "5005/5", "1025/5" ]

.fi
.RE

.PP
Here we define:

.TP
name
\fB\fCpgo\fR, how to address this service on this machine.
.TP
user
\fB\fCmiek\fR, run podman under this user. This username only need to exist on the target machine and has
no relation to the SSH user connecting to \fB\fCpgod\fR. I.e. it could be \fB\fCnobody\fR.
.TP
group
\fB\fCmiek\fR, run podman with this group. Not used at the moment, the primary group of "user" is used.
.TP
repository \fIand\fP branch
\fB\fChttps://github.com/miekg/pgo\fR and \fB\fCmain\fR, where to clone and pull from.
.TP
urls
\fB\fC{ "example.org" = ":5006" }\fR how to setup any forwarding to the listening ports. This isn't used yet,
but when the containers go up this should connect the url \fB\fCexample.org\fR to \fB\fC<thismachine>:5006\fR.
.TP
ports
\fB\fC[ "5005/5", "1025/5" ]\fR, this service can bind to ports nummbers: 5005-5010 and 1025-1030. This
is checked by parsing the \fB\fCdocker-compose-yml\fR.


.SH "AUTHENTICATION"
.PP
All remote access is authenticated and encrypted using SSH. The \fBpublic\fP keys you use \fIMUST\fP be
put in \fB\fCssh\fR subdirectory in the top level of your repository. The \fBprivate\fP is used in
combination with pgoctl(1).

.PP
The generated key can't have a passphrase, to generate use: \fB\fCssh-keygen -t ed25519 -f ssh/id_pgo\fR.
And add and commit \fB\fCid_pgo.pub\fR.

.SH "METRICS"
.PP
There are no metrics yet.

.SH "EXIT CODE"
.PP
Pgod has following exit codes:

.PP
0 - normal exit
1 - error seen (log.Fatal())
2 - SIGHUP seen (signal to systemd to restart us)

.SH "SEE ALSO"
.PP
See this design doc
\[la]https://miek.nl/2022/november/15/provisioning-services/\[ra], and
gitopper
\[la]https://github.com/miekg/gitopper\[ra]. And see pgoctl(1) podman-compose(1).

