.\" Generated by Mmark Markdown Processer - mmark.miek.nl
.TH "PGOD" 8 "March 2024" "System Administration" "Docker Compose"

.SH "PGOD"
.SH "NAME"
.PP
pgod - watch a git repository, pull changes and restart the docker compose service

.SH "SYNOPSIS"
.PP
\fB\fCpgod [OPTION]...\fR \fB\fC-c\fR \fBCONFIG\fP

.SH "DESCRIPTION"
.PP
\fB\fCpgod\fR clones and pulls all repositories that are defined in the config file. It then starts all
containers using the compose file in each repository. Further more it exposes an SSH interface (on
port 2222) which you can interact with using pgoctl(1). Authentication is done via ssh public keys
that are available in each repository. Each \fIcompose\fP runs under it's own user-account

.PP
Servers running pgod(8) as still special in some regard, a developers needs to know which server
runs their compose file. Moving services to a different machine is as easy as starting the compose
there, but you need to make sure your infra also updates externals records (DNS for example).

.PP
The interface into \fB\fCpgod\fR is via SSH, but not OpenSSH, this is a completely seperate SSH interface
implemented by both \fB\fCpgod\fR and \fB\fCpgoctl\fR.

.PP
For each repository it directs docker compose to pull and start the containers defined in the
\fB\fCcompose.yaml\fR file. Whenever this compose file changes this is redone. Current the following
compose file variants are supported: "compose.yaml", "compose.yml", "docker-compose.yml" and
"docker-compose.yaml".

.PP
With pgoctl(1) you can then interact with these services. You can "up", "down", "ps", "pull",
"logs", and "ping" currently. The syntax exposed is \fB\fC<servicename>//<command>\fR, i.e. \fB\fCpgo//ps\fR.

.PP
On startup pgod(8) will down and remove any services that exist, but are not defined in the
confguration file.

.PP
The options are:

.TP
\fB-c, --config string\fP
config file to read, when not given this default to \fB\fC/etc/pgo.toml\fR
.TP
\fB-d, --dir string\fP
directory where to check out the git repositories, this must be a directory that is not wiped
when the system reboots; the directory must also be accessible for all user accounts defined
in the configuration file; this default to \fB\fC/var/lib/pgo\fR.
.TP
\fB-s, --ssh string\fP
ssh address to listen on (default ":2222")
.TP
\fB-t, --duration duration\fP
default duration between pulls (default 5m0s)
.TP
\fB--debug\fP
enable debug logging
.TP
\fB--restart\fP
send SIGHUP to ourselves when config changes (default true)
.TP
\fB-v\fP, \fB--version\fP
show version and exit


.SH "CONFIG FILE"
.PP
\fB\fCpgod\fR requires a TOML config file where the services are defined, an example config file looks like
this:

.PP
.RS

.nf
[[services]]
name = "pgo"
user = "miek"
repository = "https://github.com/miekg/pgo"
branch = "main"
registries = [ "user:token@registry" ]
compose = "my\-compose.yaml"
env = [ "MYVAR=VALUE" ]
urls = { "example.org" = "pgo:5006" }
networks = [ "reverse\_proxy" ]
import = "Caddyfile\-import"
reload = "localhost:caddy//exec caddy reload \-\-config /etc/caddy/Caddyfile \-\-adapter caddyfile"

.fi
.RE

.PP
Here we define:

.TP
name
\fB\fCpgo\fR, how to address this service on this machine.
.TP
user
\fB\fCmiek\fR, run docker under this user. This username only need to exist on the target machine and has
no relation to the SSH user connecting to \fB\fCpgod\fR. I.e. it could be \fB\fCnobody\fR.
.TP
repository \fIand\fP branch
\fB\fChttps://github.com/miekg/pgo\fR and \fB\fCmain\fR, where to clone and pull from. If branch is not
specified \fB\fCmain\fR is assumed.
.TP
registries:
\fB\fCuser:token@registry\fR, docker login credentials, this is used to login the registry and pull the
containers. Note that different credentials for the same user in different services might lead to
race conditions (and failed pulls). If the user part is not specifiied, the user from the \fB\fCuser\fR
keyword is used. This is a list because multiple private repositories are allowed.
.TP
compose
\fB\fCmy-compose.yaml\fR, specify an alternate compose file to use, outside of the supported variants.
.TP
env
\fB\fC"MYVAR=VALUE"\fR, specify environment variables to be exposed to the service.
.TP
urls
\fB\fC{ "example.org" = "pgo:5006" }\fR how to setup any forwarding to the listening ports.
but when the containers go up this should connect the url \fB\fCexample.org\fR to \fB\fC<service>:5006\fR.
.TP
networks:
\fB\fC[ "reverse_proxy" ]\fR, allowed external networks. If empty all networks are allowed to be used.
.TP
import:
\fB\fC"Caddyfile-import"\fR, generate a Caddy (import) file that sets up the reverse proxies for \fIall\fP
services that are defined. If you have an \fB\fCimport\fR you also want to have a \fB\fCreload\fR.
.TP
reload:
\fB\fClocalhost:caddy//exec caddy --config Caddyfile --adapter caddyfile\fR, this is a pgoctl(1) exec
command line that runs \fB\fCdocker compose exec caddy caddy --config...\fR, to reload caddy in its
container. Note that the machine (here \fB\fClocalhost\fR) is not used, and could be anything.


.SH "REVERSE PROXY"
.PP
Usually a Caddy server is run on the host port 443 (and 80 for Let's Encrypt TLS certificates
validation). This Caddy need to be able to reads the "import" file to be able to function. Only one
service needs to specify this file, and usually this is the caddy service (that can also be managed
by pgod).

.SH "AUTHENTICATION"
.PP
All remote access is authenticated and encrypted using SSH. The \fBpublic\fP keys you use \fIMUST\fP be
put in \fB\fCssh\fR subdirectory in the top level of your repository. The \fBprivate\fP key is used in
combination with pgoctl(1) and should \fInever be checked in\fP.

.PP
The generated key can't have a passphrase, to generate use: \fB\fCssh-keygen -t ed25519 -f ssh/id_pgo\fR.
And add and commit \fB\fCssh/id_pgo.pub\fR, and use \fB\fCssh/id_pgo\fR for authentication.

.SH "METRICS"
.PP
Two metrics are exported:

.IP \(bu 4
\fB\fCpgo_command_count\fR: total of commands executed
.IP \(bu 4
\fB\fCpgo_command_error_count\fR: count of errors resulting from command execution


.SH "EXIT CODE"
.PP
pgod(8) has following exit codes:

.PP
0 - normal exit
1 - error seen (log.Fatal())
2 - SIGHUP seen (signal to systemd to restart us)

.SH "FILES"
.PP
If a \fB\fC<service>\fR.stop file exists in the pgo directory (\fB-d\fP flag), and that service exists the
service will not be started or be stopped if it is started. This will be checked in the normal
cycle (usally every 5 minutes).

.SH "SEE ALSO"
.PP
See this design doc
\[la]https://miek.nl/2022/november/15/provisioning-services/\[ra], and
gitopper
\[la]https://github.com/miekg/gitopper\[ra]. And see pgoctl(1) docker(1).

